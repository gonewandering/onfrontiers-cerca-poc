<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prompt Management - Cerca</title>
    <style>
        * { box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            margin: 0; padding: 20px; background-color: #f5f5f5;
        }
        .container {
            max-width: 1600px; margin: 0 auto; background: white;
            border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        /* Header component styles */
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; padding: 20px; text-align: center; position: relative;
        }
        
        .nav-links {
            position: absolute; top: 20px; left: 20px; display: flex; gap: 15px;
        }
        
        .nav-link {
            color: rgba(255, 255, 255, 0.9); text-decoration: none; padding: 8px 16px;
            border-radius: 20px; background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px); transition: all 0.3s ease;
            font-size: 14px; font-weight: 500;
        }
        
        .nav-link:hover {
            background: rgba(255, 255, 255, 0.2); color: white; transform: translateY(-1px);
        }
        
        .nav-link.active {
            background: rgba(255, 255, 255, 0.3); color: white;
        }
        .content { padding: 20px; }
        .toolbar {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 6px;
        }
        .btn {
            padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer;
            font-size: 14px; font-weight: 500; transition: all 0.2s;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .btn-primary:hover { transform: translateY(-1px); }
        .btn-secondary {
            background: #6c757d; color: white;
        }
        .btn-success {
            background: #28a745; color: white;
        }
        .btn-warning {
            background: #ffc107; color: #212529;
        }
        .btn-danger {
            background: #dc3545; color: white;
        }
        .btn-small { padding: 4px 8px; font-size: 12px; }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
        
        .template-section {
            margin-bottom: 30px; border: 1px solid #e9ecef; border-radius: 8px; overflow: hidden;
        }
        .template-header {
            background: #f8f9fa; padding: 15px; border-bottom: 1px solid #e9ecef;
            display: flex; justify-content: space-between; align-items: center;
        }
        .template-name {
            font-size: 18px; font-weight: 600; color: #343a40;
        }
        .template-type {
            background: #e9ecef; color: #495057; padding: 4px 12px;
            border-radius: 12px; font-size: 12px; text-transform: uppercase; margin-left: 10px;
        }
        .template-type.expert_extraction { background: #d4edda; color: #155724; }
        .template-type.expert_search { background: #cce5f0; color: #0c5460; }
        .template-actions {
            display: flex; gap: 8px; align-items: center;
        }
        .template-settings {
            margin-left: 10px; display: inline-flex; gap: 6px; align-items: center;
        }
        .setting-chip {
            background: #e9ecef; color: #495057; padding: 2px 6px;
            border-radius: 4px; font-size: 11px; font-weight: 500;
        }
        .setting-chip.model-gpt-4o-mini { background: #d4edda; color: #155724; }
        .setting-chip.model-gpt-4o { background: #cce5f0; color: #0c5460; }
        .setting-chip.model-gpt-4 { background: #e2d9f3; color: #6f42c1; }
        .setting-chip.enabled { background: #d4edda; color: #155724; }
        
        .version-list {
            display: none;
        }
        .version-list.expanded {
            display: block;
        }
        .version-item {
            border-bottom: 1px solid #f0f0f0; padding: 12px 15px;
            display: flex; justify-content: space-between; align-items: center;
            transition: background-color 0.2s;
        }
        .version-item:hover { background-color: #f8f9fa; }
        .version-item:last-child { border-bottom: none; }
        
        .version-info {
            flex: 1;
        }
        .version-header {
            display: flex; align-items: center; gap: 8px; margin-bottom: 4px;
        }
        .version-number {
            font-weight: 600; color: #495057;
        }
        .badge {
            padding: 2px 6px; border-radius: 4px; font-size: 11px; font-weight: 500;
        }
        .badge-active { background: #d4edda; color: #155724; }
        .badge-inactive { background: #f8d7da; color: #721c24; }
        .badge-default { background: #fff3cd; color: #856404; }
        
        .version-meta {
            font-size: 12px; color: #6c757d; display: flex; gap: 15px;
        }
        .version-actions {
            display: flex; gap: 6px;
        }
        
        .loading {
            text-align: center; padding: 40px; color: #6c757d;
        }
        .error {
            background: #f8d7da; color: #721c24; padding: 12px;
            border-radius: 6px; margin-bottom: 16px;
        }
        
        /* Modal styles */
        .modal {
            display: none; position: fixed; z-index: 1000; left: 0; top: 0;
            width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);
        }
        .modal-content {
            background-color: white; margin: 2% auto; padding: 0;
            border-radius: 8px; width: 95%; max-width: 900px; max-height: 95vh;
            overflow-y: auto;
        }
        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; padding: 20px; border-radius: 8px 8px 0 0;
        }
        .modal-body {
            padding: 20px;
        }
        .close {
            color: white; float: right; font-size: 28px; font-weight: bold;
            cursor: pointer;
        }
        .close:hover { opacity: 0.7; }
        .form-group {
            margin-bottom: 15px;
        }
        .form-label {
            display: block; margin-bottom: 5px; font-weight: 500;
        }
        .form-control {
            width: 100%; padding: 8px 12px; border: 1px solid #ced4da;
            border-radius: 4px; font-size: 14px;
        }
        .form-control:focus {
            outline: none; border-color: #667eea; box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.25);
        }
        textarea.form-control {
            resize: vertical; min-height: 100px; font-family: 'Monaco', 'Menlo', monospace;
            font-size: 13px; line-height: 1.4;
        }
        select.form-control {
            height: 38px;
        }
        .form-help {
            font-size: 12px; color: #6c757d; margin-top: 4px;
        }
        
        .expand-toggle {
            cursor: pointer; display: inline-flex; align-items: center; gap: 5px;
            color: #667eea; font-weight: 500;
        }
        .expand-toggle:hover { text-decoration: underline; }
        .expand-icon {
            transition: transform 0.2s;
        }
        .expand-icon.expanded {
            transform: rotate(90deg);
        }
        
        .setting-enabled {
            color: #28a745; font-weight: 500;
        }
        .setting-disabled {
            color: #6c757d; opacity: 0.7;
        }
        .version-notes {
            font-size: 12px; color: #495057; margin-top: 6px;
            padding: 4px 8px; background: #f8f9fa; border-radius: 4px;
            border-left: 3px solid #667eea;
        }
        .version-description {
            font-size: 13px; color: #6c757d; margin-top: 4px; font-style: italic;
        }
        
        /* Settings panel styles */
        .version-details {
            background: #f8f9fa; padding: 15px; border-top: 1px solid #e9ecef;
            margin: 0 -15px; 
        }
        .settings-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px; margin-bottom: 15px;
        }
        .setting-group h4 {
            margin: 0 0 10px 0; font-size: 14px; font-weight: 600; 
            color: #495057; border-bottom: 1px solid #dee2e6; padding-bottom: 5px;
        }
        .setting-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 6px 0; font-size: 13px;
        }
        .setting-label {
            font-weight: 500; color: #6c757d;
        }
        .setting-value {
            font-weight: 600; color: #495057;
        }
        
        /* Model-specific styling */
        .model-gpt-4o-mini { color: #28a745; }
        .model-gpt-4o { color: #007bff; }
        .model-gpt-4 { color: #6f42c1; }
        
        .temperature-desc {
            font-size: 11px; color: #6c757d; font-weight: normal; margin-left: 5px;
        }
        
        .feature-enabled { color: #28a745; font-weight: 600; }
        .feature-disabled { color: #6c757d; }
        .status-active { color: #28a745; font-weight: 600; }
        .status-inactive { color: #6c757d; }
        .status-default { color: #ffc107; font-weight: 600; margin-left: 8px; }
        
        .schema-preview {
            margin-top: 15px; padding-top: 15px; border-top: 1px solid #dee2e6;
        }
        .schema-preview h4 {
            margin: 0 0 10px 0; font-size: 14px; font-weight: 600; color: #495057;
        }
        .schema-code {
            background: #fff; border: 1px solid #dee2e6; border-radius: 4px;
            padding: 12px; font-size: 11px; line-height: 1.4; overflow-x: auto;
            max-height: 200px; overflow-y: auto; font-family: 'Monaco', 'Menlo', monospace;
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="header-container">
            <!-- Header will be rendered here by the component -->
        </div>
        
        <div class="content">
            <div class="toolbar">
                <div>
                    <h3>Prompt Templates</h3>
                    <p style="margin: 0; font-size: 14px; color: #6c757d;">
                        Each template can have multiple versions. Only one version per template can be active.
                    </p>
                </div>
                <button class="btn btn-primary" onclick="showCreateModal()">+ Create New Version</button>
            </div>
            
            <div id="templates-list">
                <div class="loading">Loading prompt templates...</div>
            </div>
        </div>
    </div>

    <!-- Create/Edit Modal -->
    <div id="promptModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="close" onclick="closeModal()">&times;</span>
                <h2 id="modalTitle">Create New Prompt Version</h2>
            </div>
            <div class="modal-body">
                <form id="promptForm">
                    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 15px; margin-bottom: 15px;">
                        <div class="form-group">
                            <label class="form-label" for="templateName">Template Name *</label>
                            <input type="text" class="form-control" id="templateName" required>
                            <div class="form-help">The identifier for this prompt template (e.g., "expert_extraction")</div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="promptType">Type *</label>
                            <select class="form-control" id="promptType" required>
                                <option value="expert_extraction">Expert Extraction</option>
                                <option value="expert_search">Expert Search</option>
                                <option value="attribute_search">Attribute Search</option>
                                <option value="custom">Custom</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="promptDescription">Description</label>
                        <textarea class="form-control" id="promptDescription" rows="2"></textarea>
                        <div class="form-help">Brief description of what this prompt does</div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="systemPrompt">System Prompt *</label>
                        <textarea class="form-control" id="systemPrompt" rows="8" required></textarea>
                        <div class="form-help">Instructions that define the AI's behavior and role</div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="userPromptTemplate">User Prompt Template *</label>
                        <textarea class="form-control" id="userPromptTemplate" rows="4" required></textarea>
                        <div class="form-help">Template for user input. Use {text} for variable substitution</div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="responseSchema">Response Schema (JSON)</label>
                        <textarea class="form-control" id="responseSchema" rows="6"></textarea>
                        <div class="form-help">JSON schema defining the expected response structure</div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="form-group">
                            <label class="form-label" for="model">Model</label>
                            <select class="form-control" id="model">
                                <option value="gpt-4o-mini">GPT-4o Mini (Recommended)</option>
                                <option value="gpt-4o">GPT-4o</option>
                                <option value="gpt-4">GPT-4</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="temperature">Temperature</label>
                            <input type="number" class="form-control" id="temperature" min="0" max="2" step="0.1" value="0.1">
                            <div class="form-help">0.0 = deterministic, 2.0 = very creative</div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="versionNotes">Version Notes</label>
                        <textarea class="form-control" id="versionNotes" rows="2"></textarea>
                        <div class="form-help">What changes were made in this version?</div>
                    </div>
                    
                    <div style="display: flex; gap: 15px; align-items: center; margin-bottom: 20px;">
                        <label>
                            <input type="checkbox" id="enableAttributeSearch"> Enable Attribute Search
                        </label>
                        <label>
                            <input type="checkbox" id="isActiveVersion" checked> Set as Active Version
                        </label>
                    </div>
                    
                    <div style="display: flex; gap: 10px; justify-content: flex-end;">
                        <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Prompt Version</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="/static/components/header.js"></script>
    <script>
        let templates = [];
        let editingPromptId = null;

        // Initialize header and load templates on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Render the header
            const header = new CercaHeader(
                'Prompt Management', 
                'Manage LLM prompt templates and versions for expert indexing and search',
                'prompts'
            );
            document.getElementById('header-container').innerHTML = header.render();
            
            // Load templates
            loadTemplates();
        });

        async function loadTemplates() {
            try {
                const response = await fetch('/api/prompts?show_all_versions=true');
                if (!response.ok) throw new Error(`Failed to load prompts: ${response.status}`);
                
                const data = await response.json();
                
                // Group prompts by template_name
                const grouped = {};
                data.prompts.forEach(prompt => {
                    if (!grouped[prompt.template_name]) {
                        grouped[prompt.template_name] = [];
                    }
                    grouped[prompt.template_name].push(prompt);
                });
                
                templates = grouped;
                displayTemplates();
                
            } catch (error) {
                document.getElementById('templates-list').innerHTML = 
                    `<div class="error">Error loading prompts: ${error.message}</div>`;
            }
        }

        function displayTemplates() {
            const container = document.getElementById('templates-list');
            
            if (Object.keys(templates).length === 0) {
                container.innerHTML = '<div class="loading">No prompt templates found. Create your first template!</div>';
                return;
            }

            let html = '';
            Object.keys(templates).sort().forEach(templateName => {
                const versions = templates[templateName].sort((a, b) => b.version_number - a.version_number);
                const activeVersion = versions.find(v => v.is_active_version);
                
                html += `
                    <div class="template-section">
                        <div class="template-header">
                            <div>
                                <span class="template-name">${templateName}</span>
                                <span class="template-type ${versions[0].prompt_type}">${versions[0].prompt_type}</span>
                                ${activeVersion ? `
                                    <span class="badge badge-active">v${activeVersion.version_number} Active</span>
                                    <span class="template-settings">
                                        <span class="setting-chip model-${activeVersion.model.replace(/[^a-z0-9]/gi, '-')}">${activeVersion.model}</span>
                                        <span class="setting-chip">T: ${activeVersion.temperature}</span>
                                        ${activeVersion.enable_attribute_search ? '<span class="setting-chip enabled">🔍 Search</span>' : ''}
                                    </span>
                                ` : '<span class="badge badge-inactive">No Active Version</span>'}
                            </div>
                            <div class="template-actions">
                                <span class="expand-toggle" onclick="toggleVersions('${templateName}')">
                                    <span class="expand-icon" id="icon-${templateName}">▶</span>
                                    ${versions.length} version${versions.length !== 1 ? 's' : ''}
                                </span>
                                <button class="btn btn-primary btn-small" onclick="createVersion('${templateName}', '${versions[0].prompt_type}')">+ New Version</button>
                            </div>
                        </div>
                        <div class="version-list" id="versions-${templateName}">
                `;
                
                versions.forEach(version => {
                    html += `
                        <div class="version-item">
                            <div class="version-info">
                                <div class="version-header">
                                    <span class="version-number">Version ${version.version_number}</span>
                                    ${version.is_active_version ? '<span class="badge badge-active">Active</span>' : '<span class="badge badge-inactive">Inactive</span>'}
                                    ${version.is_default ? '<span class="badge badge-default">Default</span>' : ''}
                                </div>
                                <div class="version-meta">
                                    <span>Model: ${version.model}</span>
                                    <span>Temperature: ${version.temperature}</span>
                                    ${version.enable_attribute_search ? '<span class="setting-enabled">🔍 Attr Search</span>' : '<span class="setting-disabled">🔍 Attr Search</span>'}
                                    <span>Created: ${new Date(version.created_at).toLocaleDateString()}</span>
                                    ${version.created_by ? `<span>By: ${version.created_by}</span>` : ''}
                                </div>
                                ${version.version_notes ? `<div class="version-notes">📝 ${version.version_notes}</div>` : ''}
                                ${version.description ? `<div class="version-description">${version.description}</div>` : ''}
                            </div>
                            <div class="version-actions">
                                <button class="btn btn-secondary btn-small" onclick="toggleVersionDetails(${version.id})">⚙️ Settings</button>
                                ${!version.is_active_version ? `<button class="btn btn-success btn-small" onclick="activateVersion(${version.id})">Activate</button>` : ''}
                                <button class="btn btn-secondary btn-small" onclick="viewVersion(${version.id})">View</button>
                                <button class="btn btn-warning btn-small" onclick="editVersion(${version.id})">Edit</button>
                                ${!version.is_default ? `<button class="btn btn-danger btn-small" onclick="deleteVersion(${version.id})">Delete</button>` : ''}
                            </div>
                        </div>
                        <div class="version-details" id="details-${version.id}" style="display: none;">
                            <div class="settings-grid">
                                <div class="setting-group">
                                    <h4>Model Configuration</h4>
                                    <div class="setting-item">
                                        <span class="setting-label">Model:</span>
                                        <span class="setting-value model-${version.model.replace(/[^a-z0-9]/gi, '-')}">${version.model}</span>
                                    </div>
                                    <div class="setting-item">
                                        <span class="setting-label">Temperature:</span>
                                        <span class="setting-value">
                                            ${version.temperature}
                                            <span class="temperature-desc">
                                                ${version.temperature <= 0.2 ? '(Very Deterministic)' : 
                                                  version.temperature <= 0.5 ? '(Deterministic)' : 
                                                  version.temperature <= 1.0 ? '(Balanced)' : 
                                                  version.temperature <= 1.5 ? '(Creative)' : '(Very Creative)'}
                                            </span>
                                        </span>
                                    </div>
                                </div>
                                
                                <div class="setting-group">
                                    <h4>Features</h4>
                                    <div class="setting-item">
                                        <span class="setting-label">Attribute Search:</span>
                                        <span class="setting-value">
                                            ${version.enable_attribute_search ? 
                                                '<span class="feature-enabled">✓ Enabled</span>' : 
                                                '<span class="feature-disabled">✗ Disabled</span>'}
                                        </span>
                                    </div>
                                    <div class="setting-item">
                                        <span class="setting-label">Status:</span>
                                        <span class="setting-value">
                                            ${version.is_active_version ? '<span class="status-active">🟢 Active Version</span>' : '<span class="status-inactive">⚪ Inactive</span>'}
                                            ${version.is_default ? '<span class="status-default">⭐ System Default</span>' : ''}
                                        </span>
                                    </div>
                                </div>
                                
                                <div class="setting-group">
                                    <h4>Metadata</h4>
                                    <div class="setting-item">
                                        <span class="setting-label">Version:</span>
                                        <span class="setting-value">${version.version_number}</span>
                                    </div>
                                    <div class="setting-item">
                                        <span class="setting-label">Created:</span>
                                        <span class="setting-value">${new Date(version.created_at).toLocaleString()}</span>
                                    </div>
                                    <div class="setting-item">
                                        <span class="setting-label">Updated:</span>
                                        <span class="setting-value">${new Date(version.updated_at).toLocaleString()}</span>
                                    </div>
                                    ${version.created_by ? `
                                    <div class="setting-item">
                                        <span class="setting-label">Author:</span>
                                        <span class="setting-value">${version.created_by}</span>
                                    </div>
                                    ` : ''}
                                </div>
                            </div>
                            
                            ${version.response_schema ? `
                            <div class="schema-preview">
                                <h4>Response Schema</h4>
                                <pre class="schema-code">${JSON.stringify(version.response_schema, null, 2)}</pre>
                            </div>
                            ` : ''}
                        </div>
                        </div>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function toggleVersions(templateName) {
            const versionsList = document.getElementById(`versions-${templateName}`);
            const icon = document.getElementById(`icon-${templateName}`);
            
            if (versionsList.classList.contains('expanded')) {
                versionsList.classList.remove('expanded');
                icon.textContent = '▶';
                icon.classList.remove('expanded');
            } else {
                versionsList.classList.add('expanded');
                icon.textContent = '▼';
                icon.classList.add('expanded');
            }
        }

        function toggleVersionDetails(versionId) {
            const detailsPanel = document.getElementById(`details-${versionId}`);
            const settingsBtn = event.target;
            
            if (detailsPanel.style.display === 'none' || !detailsPanel.style.display) {
                detailsPanel.style.display = 'block';
                settingsBtn.textContent = '⚙️ Hide Settings';
                settingsBtn.classList.add('btn-warning');
                settingsBtn.classList.remove('btn-secondary');
            } else {
                detailsPanel.style.display = 'none';
                settingsBtn.textContent = '⚙️ Settings';
                settingsBtn.classList.add('btn-secondary');
                settingsBtn.classList.remove('btn-warning');
            }
        }

        function showCreateModal() {
            editingPromptId = null;
            document.getElementById('modalTitle').textContent = 'Create New Prompt Version';
            document.getElementById('promptForm').reset();
            document.getElementById('isActiveVersion').checked = true;
            document.getElementById('promptModal').style.display = 'block';
        }
        
        function createVersion(templateName, promptType) {
            editingPromptId = null;
            document.getElementById('modalTitle').textContent = `Create New Version - ${templateName}`;
            document.getElementById('promptForm').reset();
            document.getElementById('templateName').value = templateName;
            document.getElementById('promptType').value = promptType;
            document.getElementById('templateName').readOnly = true;
            document.getElementById('promptType').disabled = true;
            document.getElementById('isActiveVersion').checked = true;
            document.getElementById('promptModal').style.display = 'block';
        }

        async function viewVersion(promptId) {
            try {
                const response = await fetch(`/api/prompts/${promptId}`);
                if (!response.ok) throw new Error(`Failed to load prompt: ${response.status}`);
                
                const prompt = await response.json();
                
                // Show in modal as read-only
                editingPromptId = null;
                document.getElementById('modalTitle').textContent = `View Version ${prompt.version_number} - ${prompt.template_name}`;
                
                document.getElementById('templateName').value = prompt.template_name;
                document.getElementById('promptType').value = prompt.prompt_type;
                document.getElementById('promptDescription').value = prompt.description || '';
                document.getElementById('systemPrompt').value = prompt.system_prompt;
                document.getElementById('userPromptTemplate').value = prompt.user_prompt_template;
                document.getElementById('responseSchema').value = JSON.stringify(prompt.response_schema, null, 2);
                document.getElementById('model').value = prompt.model;
                document.getElementById('temperature').value = prompt.temperature;
                document.getElementById('versionNotes').value = prompt.version_notes || '';
                document.getElementById('enableAttributeSearch').checked = prompt.enable_attribute_search;
                document.getElementById('isActiveVersion').checked = prompt.is_active_version;
                
                // Make all fields read-only
                const form = document.getElementById('promptForm');
                Array.from(form.elements).forEach(element => {
                    if (element.type !== 'button') {
                        element.readOnly = true;
                        element.disabled = true;
                    }
                });
                
                // Hide save button
                form.querySelector('button[type="submit"]').style.display = 'none';
                
                document.getElementById('promptModal').style.display = 'block';
                
            } catch (error) {
                alert(`Error loading prompt: ${error.message}`);
            }
        }

        async function editVersion(promptId) {
            try {
                const response = await fetch(`/api/prompts/${promptId}`);
                if (!response.ok) throw new Error(`Failed to load prompt: ${response.status}`);
                
                const prompt = await response.json();
                
                editingPromptId = promptId;
                document.getElementById('modalTitle').textContent = `Edit Version ${prompt.version_number} - ${prompt.template_name}`;
                
                document.getElementById('templateName').value = prompt.template_name;
                document.getElementById('promptType').value = prompt.prompt_type;
                document.getElementById('promptDescription').value = prompt.description || '';
                document.getElementById('systemPrompt').value = prompt.system_prompt;
                document.getElementById('userPromptTemplate').value = prompt.user_prompt_template;
                document.getElementById('responseSchema').value = JSON.stringify(prompt.response_schema, null, 2);
                document.getElementById('model').value = prompt.model;
                document.getElementById('temperature').value = prompt.temperature;
                document.getElementById('versionNotes').value = prompt.version_notes || '';
                document.getElementById('enableAttributeSearch').checked = prompt.enable_attribute_search;
                document.getElementById('isActiveVersion').checked = prompt.is_active_version;
                
                // Template name and type should not be editable when editing
                document.getElementById('templateName').readOnly = true;
                document.getElementById('promptType').disabled = true;
                
                document.getElementById('promptModal').style.display = 'block';
                
            } catch (error) {
                alert(`Error loading prompt: ${error.message}`);
            }
        }

        async function activateVersion(promptId) {
            if (!confirm('Are you sure you want to activate this version? This will deactivate the currently active version.')) return;
            
            try {
                const response = await fetch(`/api/prompts/${promptId}/activate`, { method: 'POST' });
                if (!response.ok) throw new Error(`Failed to activate version: ${response.status}`);
                
                await loadTemplates(); // Reload the list
                
            } catch (error) {
                alert(`Error activating version: ${error.message}`);
            }
        }

        async function deleteVersion(promptId) {
            if (!confirm('Are you sure you want to delete this prompt version?')) return;
            
            try {
                const response = await fetch(`/api/prompts/${promptId}`, { method: 'DELETE' });
                if (!response.ok) throw new Error(`Failed to delete version: ${response.status}`);
                
                await loadTemplates(); // Reload the list
                
            } catch (error) {
                alert(`Error deleting version: ${error.message}`);
            }
        }

        function closeModal() {
            document.getElementById('promptModal').style.display = 'none';
            editingPromptId = null;
            
            // Reset form state
            const form = document.getElementById('promptForm');
            Array.from(form.elements).forEach(element => {
                element.readOnly = false;
                element.disabled = false;
            });
            form.querySelector('button[type="submit"]').style.display = 'inline-block';
        }

        document.getElementById('promptForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = {
                template_name: document.getElementById('templateName').value,
                prompt_type: document.getElementById('promptType').value,
                description: document.getElementById('promptDescription').value,
                system_prompt: document.getElementById('systemPrompt').value,
                user_prompt_template: document.getElementById('userPromptTemplate').value,
                response_schema: document.getElementById('responseSchema').value,
                model: document.getElementById('model').value,
                temperature: parseFloat(document.getElementById('temperature').value),
                enable_attribute_search: document.getElementById('enableAttributeSearch').checked,
                is_active_version: document.getElementById('isActiveVersion').checked,
                version_notes: document.getElementById('versionNotes').value
            };
            
            // Parse response schema if provided
            if (formData.response_schema) {
                try {
                    formData.response_schema = JSON.parse(formData.response_schema);
                } catch (error) {
                    alert('Invalid JSON in Response Schema field');
                    return;
                }
            }
            
            try {
                const url = editingPromptId ? `/api/prompts/${editingPromptId}` : '/api/prompts';
                const method = editingPromptId ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || `Request failed: ${response.status}`);
                }
                
                closeModal();
                await loadTemplates(); // Reload the list
                
            } catch (error) {
                alert(`Error saving prompt: ${error.message}`);
            }
        });

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('promptModal');
            if (event.target === modal) {
                closeModal();
            }
        }
    </script>
</body>
</html>